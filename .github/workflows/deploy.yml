name: Deploy to Streamlit Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production

env:
  STREAMLIT_SERVER_PORT: 8501
  STREAMLIT_SERVER_ADDRESS: 0.0.0.0

jobs:
  deploy:
    name: Deploy to Streamlit Cloud
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip uv
        uv pip install -e .
        
    - name: Run pre-deployment tests
      run: |
        python -m pytest tests/ -v --tb=short
        
    - name: Validate Streamlit app
      run: |
        streamlit run app.py --server.headless true &
        sleep 10
        curl -f http://localhost:8501/healthz || exit 1
        pkill -f streamlit
        
    - name: Deploy to Streamlit Cloud
      run: |
        echo "Deploying to Streamlit Cloud..."
        # Streamlit Cloud automatically deploys from GitHub when you push to the main branch
        # You can also use their API for more control
        
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        # Add health check for your deployed app
        # curl -f ${{ secrets.STREAMLIT_APP_URL }}/healthz || exit 1
        
    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      if: success()
      with:
        status: success
        text: 'üöÄ Successfully deployed Campus Management System to Streamlit Cloud!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: Notify deployment failure
      uses: 8398a7/action-slack@v3
      if: failure()
      with:
        status: failure
        text: '‚ùå Failed to deploy Campus Management System to Streamlit Cloud'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  health-check:
    name: Post-deployment Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
    - name: Wait for deployment
      run: sleep 60
      
    - name: Health check
      run: |
        echo "Running health checks..."
        # Add your health check endpoints here
        # curl -f ${{ secrets.STREAMLIT_APP_URL }}
        
    - name: Load testing
      run: |
        echo "Running basic load test..."
        # You can add basic load testing here
        # pip install locust
        # locust -f locustfile.py --headless -u 10 -r 2 -t 30s --host ${{ secrets.STREAMLIT_APP_URL }}